<!DOCTYPE html>
<html>
<head>
    <title>WebSocket 채팅 테스트</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #chat-container {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
        }
        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
        }
        .join { color: green; }
        .leave { color: red; }
        .chat { color: black; }
        input, button {
            padding: 10px;
            margin: 5px;
        }
        #messageInput {
            width: 60%;
        }
        .connected { color: green; font-weight: bold; }
        .disconnected { color: red; font-weight: bold; }
    </style>
</head>
<body>
<h1>백전 WebSocket 채팅 테스트</h1>

<div id="chat-container">
    <div>
        <label>서버 URL:</label>
        <input type="text" id="serverUrl" value="http://13.218.231.14:8080/ws/chat" style="width: 400px;">
    </div>
    <div>
        <label>게임방 ID:</label>
        <input type="text" id="roomId" value="room123" placeholder="게임방 ID">
    </div>
    <div>
        <label>사용자 이름:</label>
        <input type="text" id="username" value="테스터1" placeholder="이름">
    </div>
    <div>
        <label>JWT 토큰 (선택):</label>
        <input type="text" id="jwtToken" placeholder="Bearer 토큰 (없으면 비워두세요)" style="width: 400px;">
    </div>
    <div>
        <button id="connectBtn" onclick="connect()">연결</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>연결 종료</button>
        <span id="status" class="disconnected">연결 안 됨</span>
    </div>
</div>

<div id="chat-container2">
    <h3>채팅</h3>
    <div id="messages"></div>
    <div>
        <input type="text" id="messageInput" placeholder="메시지 입력..." disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>전송</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const roomId = document.getElementById('roomId').value;
        const username = document.getElementById('username').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!username) {
            alert('사용자 이름을 입력하세요!');
            return;
        }

        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);

        const headers = {};
        if (jwtToken) {
            headers['Authorization'] = jwtToken.startsWith('Bearer ') ? jwtToken : 'Bearer ' + jwtToken;
        }

        stompClient.connect(headers, function(frame) {
            console.log('연결 성공: ' + frame);
            setConnected(true);

            stompClient.subscribe('/topic/game/' + roomId, function(message) {
                showMessage(JSON.parse(message.body));
            });

            stompClient.send('/app/chat.join', {}, JSON.stringify({
                roomId: roomId,
                sender: username,
                type: 'JOIN'
            }));
        }, function(error) {
            console.error('연결 실패:', error);

            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            const roomId = document.getElementById('roomId').value;
            const username = document.getElementById('username').value;

            stompClient.send('/app/chat.leave', {}, JSON.stringify({
                roomId: roomId,
                sender: username,
                type: 'LEAVE'
            }));

            stompClient.disconnect();
        }
        setConnected(false);
        console.log('연결 종료');
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (!message) {
            alert('메시지를 입력하세요!');
            return;
        }

        const roomId = document.getElementById('roomId').value;
        const username = document.getElementById('username').value;

        stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
            roomId: roomId,
            sender: username,
            message: message,
            type: 'CHAT'
        }));

        messageInput.value = '';
    }

    function showMessage(message) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + message.type.toLowerCase();

        const time = new Date(message.timestamp).toLocaleTimeString();
        console.log('받은 메시지:', message);
        if (message.type === 'JOIN') {
            messageDiv.textContent = '[' + time + '] ' + message.sender + '님이 입장했습니다.';
        } else if (message.type === 'LEAVE') {
            messageDiv.textContent = '[' + time + '] ' + message.sender + '님이 퇴장했습니다.';
        } else {
            messageDiv.textContent = '[' + time + '] ' + message.sender + ': ' + message.message;
        }

        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        document.getElementById('messageInput').disabled = !connected;
        document.getElementById('sendBtn').disabled = !connected;

        const status = document.getElementById('status');
        if (connected) {
            status.textContent = '연결됨';
            status.className = 'connected';
        } else {
            status.textContent = '연결 안 됨';
            status.className = 'disconnected';
        }
    }

    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>