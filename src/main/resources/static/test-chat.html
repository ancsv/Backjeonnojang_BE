<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>ë°±ì „ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
<div>
    <label>ê²Œì„ë°© ID: <input type="text" id="roomId" value="room123"></label><br>
    <label>ì‚¬ìš©ìëª…: <input type="text" id="username" value="player1"></label><br>
    <button onclick="connect()">ì—°ê²°</button>
    <button onclick="disconnect()">ì¢…ë£Œ</button>
</div>
<br>
<div>
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="sendMessage()">ì „ì†¡</button>
</div>
<br>
<div id="messages" style="border:1px solid #ccc; height:300px; overflow-y:scroll;"></div>

<script>
    let stompClient = null;
    let roomId = null;
    let username = null;

    function connect() {
        roomId = document.getElementById('roomId').value;
        username = document.getElementById('username').value;

        const socket = new SockJS('http://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            addMessage('ì‹œìŠ¤í…œ', 'ì—°ê²° ì„±ê³µ!');

            // ê²Œì„ë°© êµ¬ë…
            stompClient.subscribe('/topic/game/' + roomId, function(message) {
                const msg = JSON.parse(message.body);
                addMessage(msg.sender, msg.message, msg.type);
            });

            // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            stompClient.send('/app/chat.join', {}, JSON.stringify({
                roomId: roomId,
                sender: username,
                message: username + 'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.',
                type: 'JOIN'
            }));
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.send('/app/chat.leave', {}, JSON.stringify({
                roomId: roomId,
                sender: username,
                message: username + 'ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.',
                type: 'LEAVE'
            }));
            stompClient.disconnect();
        }
        addMessage('ì‹œìŠ¤í…œ', 'ì—°ê²° ì¢…ë£Œ');
        console.log("Disconnected");
    }

    function sendMessage() {
        const messageInput = document.getElementById('message');
        const message = messageInput.value;

        if (message && stompClient) {
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
                roomId: roomId,
                sender: username,
                message: message,
                type: 'CHAT'
            }));
            messageInput.value = '';
        }
    }

    function addMessage(sender, message, type) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');

        let prefix = type === 'JOIN' ? 'ğŸŸ¢ ' : type === 'LEAVE' ? 'ğŸ”´ ' : '';
        messageElement.textContent = prefix + sender + ': ' + message;

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Enter í‚¤ë¡œ ì „ì†¡
    document.getElementById('message').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>